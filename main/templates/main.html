{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>MessyTen</title>
{% endblock meta %}

{% block content %}
<div class="w-full min-h-screen bg-transparent">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- HERO -->
    <section class="relative isolate overflow-hidden rounded-2xl mb-8 p-8 sm:p-10 bg-gradient-to-r from-[#0a2b5f] via-[#123e7a] to-[#4a0b2b] text-white shadow">
      <div class="pointer-events-none absolute -top-20 -right-24 h-72 w-72 bg-[#FFCD00]/20 rounded-full blur-3xl -z-10"></div>
      <div class="pointer-events-none absolute -bottom-24 -left-24 h-80 w-80 bg-[#004D98]/30 rounded-full blur-3xl -z-10"></div>

      <div class="relative z-10">
        <h2 class="text-3xl sm:text-4xl font-extrabold mb-2 tracking-tight">MessyTen</h2>
        <p class="opacity-90 max-w-2xl">Explore from classic to legendary items we got in store!</p>

        <div class="mt-5 flex flex-wrap gap-3">
          <!-- Tombol buka modal Create (AJAX) -->
          <button
            type="button"
            id="btn-create"
            data-fallback-url="{% url 'main:create_product' %}"
            class="inline-flex items-center bg-[#FFCD00] text-slate-900 font-semibold px-4 py-2 rounded-md hover:brightness-95 transition">
            Create (AJAX)
          </button>

          <!-- Fallback ke halaman create biasa -->
          <a href="{% url 'main:create_product' %}"
             class="inline-flex items-center bg-white/10 ring-1 ring-white/20 text-white font-semibold px-4 py-2 rounded-md hover:bg-white/15 transition">
            Go to Create Page
          </a>
        </div>
      </div>
    </section>

    <!-- HEADER -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">Latest MessyTen Products</h1>
      <p class="text-gray-600">Stay updated with the latest products we have</p>
    </div>

    <!-- FILTER / ACTION BAR -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white/80 backdrop-blur rounded-xl border border-[#004D98]/10 p-4 shadow-sm">
      <div class="flex flex-wrap items-center gap-3 mb-4 sm:mb-0">
        <a href="#" id="filter-all"
           class="bg-[#004D98] text-white px-4 py-2 rounded-md font-medium transition hover:brightness-110">
          All Products
        </a>
        <a href="#" id="filter-my"
           class="bg-white text-gray-700 border border-gray-200 px-4 py-2 rounded-md font-medium transition hover:brightness-110">
          My Products
        </a>
        <button id="refresh-products"
                class="inline-flex items-center px-3 py-2 rounded-md border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
          Refresh
        </button>
      </div>

      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">Last login: {{ last_login }}</div>
      {% endif %}
    </div>

    <!-- LOADING -->
    <div id="loading" class="bg-white/90 backdrop-blur rounded-xl border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-[#004D98] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- ERROR -->
    <div id="error" class="hidden bg-rose-50 border border-rose-300 text-rose-700 rounded-xl p-4"></div>

    <!-- GRID -->
    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>

    <!-- EMPTY -->
    <div id="empty" class="bg-white/90 backdrop-blur rounded-xl border border-gray-200 p-12 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-slate-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to publish products with the community.</p>
      <a href="{% url 'main:create_product' %}" class="inline-flex items-center px-4 py-2 bg-[#004D98] text-white rounded hover:brightness-110 transition">
        Create Product
      </a>
    </div>

  </div>
  
</div>

<!-- ajax CRUD  -->
<script>
/* config */
  const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
  const DELETE_URL_TEMPLATE  = `{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}`; // untuk fallback delete via AJAX langsung
  const CURRENT_USER_ID      = "{{ user.id|default_if_none:'' }}";
  
  // DOM
  const loadingSpinner = document.getElementById('loading');
  const errorMessage   = document.getElementById('error');
  const emptyState     = document.getElementById('empty');
  const grid           = document.getElementById('grid');
  
  const btnAll     = document.getElementById('filter-all');
  const btnMy      = document.getElementById('filter-my');
  const btnRefresh = document.getElementById('refresh-products');
  
  
  let activeFilter   = 'all';
  let allProductData = [];
  
  // Helper
  function showSection({ loading=false, error=false, empty=false, gridShow=false, errorText='' }) {
    loading ? loadingSpinner.classList.remove('hidden') : loadingSpinner.classList.add('hidden');
    if (error) {
      errorMessage.textContent = errorText || 'Failed to load products.';
      errorMessage.classList.remove('hidden');
    } else {
      errorMessage.textContent = '';
      errorMessage.classList.add('hidden');
    }
    empty ? emptyState.classList.remove('hidden') : emptyState.classList.add('hidden');
    if (gridShow) {
      grid.classList.remove('hidden');
      grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
      grid.classList.add('hidden');
    }
  }
  function setFilterButtons() {
    if (activeFilter === 'all') {
      btnAll.className = 'bg-[#004D98] text-white px-4 py-2 rounded-md font-medium transition hover:brightness-110';
      btnMy.className  = 'bg-white text-gray-700 border border-gray-200 px-4 py-2 rounded-md font-medium transition hover:brightness-110';
    } else {
      btnMy.className  = 'bg-[#004D98] text-white px-4 py-2 rounded-md font-medium transition hover:brightness-110';
      btnAll.className = 'bg-white text-gray-700 border border-gray-200 px-4 py-2 rounded-md font-medium transition hover:brightness-110';
    }
  }
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return null;
  }
  
  
  function buildProductCardElement(p) {
    const article = document.createElement('article');
    article.className = 'group relative rounded-2xl overflow-hidden border border-slate-200 bg-white/90 backdrop-blur shadow-sm transition hover:shadow-xl hover:-translate-y-0.5 duration-300';
    article.setAttribute('data-product-id', p.id);
  
    const strip = document.createElement('div');
    strip.className = 'h-1 w-full bg-gradient-to-r from-[#004D98] via-[#FFCD00] to-[#A50044]';
    article.appendChild(strip);
  
    const thumbWrap = document.createElement('div');
    thumbWrap.className = 'relative aspect-[16/9] overflow-hidden';
    article.appendChild(thumbWrap);
  
    if (p.thumbnail) {
      const img = document.createElement('img');
      img.src = p.thumbnail;
      img.alt = p.name || 'Product image';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.className = 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-105';
      thumbWrap.appendChild(img);
    } else {
      const fb = document.createElement('div');
      fb.className = 'w-full h-full bg-[radial-gradient(circle_at_25%_25%,#e5e7eb,transparent_40%),radial-gradient(circle_at_75%_75%,#f1f5f9,transparent_40%)]';
      thumbWrap.appendChild(fb);
    }
  
    const catWrap = document.createElement('div');
    catWrap.className = 'absolute top-3 left-3';
    const cat = document.createElement('span');
    cat.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-[11px] font-semibold bg-[#004D98] text-white shadow';
    cat.textContent = p.category_display || p.category || 'Product';
    catWrap.appendChild(cat);
    thumbWrap.appendChild(catWrap);
  
    if (p.is_featured) {
      const statWrap = document.createElement('div');
      statWrap.className = 'absolute top-3 right-3 flex gap-2';
      const feat = document.createElement('span');
      feat.className = 'inline-flex items-center px-2 py-1 rounded text-[11px] font-semibold bg-[#FFCD00] text-slate-900 shadow';
      feat.textContent = 'Featured';
      statWrap.appendChild(feat);
      thumbWrap.appendChild(statWrap);
    }
  
    const priceWrap = document.createElement('div');
    priceWrap.className = 'absolute bottom-3 left-3';
    const priceBadge = document.createElement('span');
    priceBadge.className = 'inline-flex items-center gap-1.5 rounded-md bg-white/90 px-2.5 py-1 text-xs font-semibold text-slate-900 shadow';
    priceBadge.innerHTML = `
      <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 8h7a3 3 0 1 1 0 6H9m0 0V5m0 9v5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Rp. ${p.price ?? '-'}
    `;
    priceWrap.appendChild(priceBadge);
    thumbWrap.appendChild(priceWrap);
    
    const overlay = document.createElement('div');
    overlay.className = 'pointer-events-none absolute inset-0 bg-gradient-to-t from-black/35 via-black/0 to-transparent opacity-0 transition group-hover:opacity-100';
    thumbWrap.appendChild(overlay);
    
    const quick = document.createElement('a');
    quick.className = 'absolute bottom-4 right-4 md:bottom-1/2 md:right-1/2 md:translate-x-1/2 md:translate-y-1/2 opacity-0 group-hover:opacity-100 transition inline-flex items-center gap-2 rounded-md bg-[#FFCD00] text-slate-900 text-xs font-semibold px-3 py-2 shadow';
    quick.href = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', p.id);
    quick.innerHTML = `
      Quick View
      <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path d="M12.293 5.293a1 1 0 011.414 0L18 9.586l-4.293 4.293a1 1 0 01-1.414-1.414L14.586 11H4a1 1 0 110-2h10.586l-2.293-2.293a1 1 0 010-1.414z"/>
      </svg>
      <span class="sr-only">View ${p.name ?? 'product'}</span>
    `;
    thumbWrap.appendChild(quick);
    
    const content = document.createElement('div');
    content.className = 'p-4';
    article.appendChild(content);
    
    const title = document.createElement('h3');
    title.className = 'text-base font-semibold text-slate-900 mb-2 line-clamp-2';
    const link = document.createElement('a');
    link.href = quick.href;
    link.className = 'hover:text-[#004D98] transition-colors';
    link.textContent = p.name ?? 'Untitled Product';
    title.appendChild(link);
    content.appendChild(title);
    
    const desc = document.createElement('p');
    desc.className = 'text-slate-600 text-sm leading-relaxed line-clamp-3';
    desc.textContent = p.description ?? '';
    content.appendChild(desc);
    
    const hr = document.createElement('div');
    hr.className = 'mt-4 h-px w-full bg-gradient-to-r from-transparent via-slate-200 to-transparent';
    content.appendChild(hr);
    
    const actions = document.createElement('div');
    actions.className = 'mt-3 flex items-center justify-between';
    const viewDetail = document.createElement('a');
    viewDetail.className = 'text-[#004D98] hover:underline text-sm font-medium';
    viewDetail.href = link.href;
    viewDetail.textContent = 'View details →';
    actions.appendChild(viewDetail);
    
    // Ownerr only actions AJAX dengan fallback URL safe
    if (CURRENT_USER_ID && String(CURRENT_USER_ID) === String(p.user_id)) {
      const owner = document.createElement('div');
      owner.className = 'flex items-center gap-3 text-sm';
    
      const editA = document.createElement('a');
      editA.className = 'text-slate-600 hover:text-slate-800 js-edit-product';
      editA.href = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', p.id);
      editA.dataset.id = p.id;
      editA.textContent = 'Edit';
    
      const delA = document.createElement('a');
      delA.className = 'text-[#A50044] hover:underline js-delete-product';
      delA.href = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', p.id);
      delA.dataset.id = p.id;
      delA.textContent = 'Delete';
    
      owner.appendChild(editA);
      owner.appendChild(delA);
      actions.appendChild(owner);
    }
  
    content.appendChild(actions);
    return article;
  }
  
  // render dan filter
  function renderCards(items) {
    grid.innerHTML = '';
    for (const p of items) grid.appendChild(buildProductCardElement(p));
  }
  function applyFilterAndRender() {
    setFilterButtons();
    const list = (activeFilter === 'all')
      ? allProductData
      : allProductData.filter(p => String(p.user_id) === String(CURRENT_USER_ID));
  
    if (!list.length) {
      showSection({ empty: true });
    } else {
      renderCards(list);
      showSection({ gridShow: true });
    }
  }
  
  //fetch 
  async function fetchProductsFromServer() {
    try {
      showSection({ loading: true });
      const res = await fetch(PRODUCT_API_ENDPOINT, {
        headers: { 'Accept': 'application/json' },
        cache: 'no-store',
      });
      if (!res.ok) throw new Error('Failed to fetch products');
      const data = await res.json();
      allProductData = data || [];
      applyFilterAndRender();
    } catch (err) {
      console.error(err);
      showSection({ error: true, errorText: 'Failed to load products.' });
    }
  }
  
  //events
  // Filter/Refresh
  btnAll.addEventListener('click', (e) => { e.preventDefault(); activeFilter = 'all'; applyFilterAndRender(); });
  btnMy.addEventListener('click', (e) => { e.preventDefault(); activeFilter = 'my';  applyFilterAndRender(); });
  btnRefresh.addEventListener('click', (e) => { e.preventDefault(); fetchProductsFromServer(); });
  
  // Buka Create modal (atau fallback ke halaman create)
  document.getElementById('btn-create')?.addEventListener('click', (e) => {
    e.preventDefault();
    if (typeof window.showCreateModal === 'function') {
      showCreateModal();
    } else {
      const url = e.currentTarget.dataset.fallbackUrl;
      if (url) window.location.href = url;
    }
  });
  
  // Delegasi click di GRID ke Edit/Delete
  grid.addEventListener('click', async (e) => {
    const a = e.target.closest('a');
    if (!a) return;
  
    // EDIT 
    if (a.classList.contains('js-edit-product')) {
      e.preventDefault();
      const id = a.dataset.id;
      const product = allProductData.find(x => String(x.id) === String(id));
      if (product && typeof window.showEditModal === 'function') {
        showEditModal(product);
      } else {
        window.location.href = a.href;
      }
      return;
    }
  
    // DELETE 
    if (a.classList.contains('js-delete-product')) {
      e.preventDefault();
      const id = a.dataset.id;
    
      if (typeof window.showConfirmDelete === 'function') {
        // gunakan modal konfirmasi custom
        showConfirmDelete(id);
        return;
      }
    
      // fallback bawaan browser
      const ok = confirm('Are you sure you want to delete this product?');
      if (!ok) return;
    
      const url = DELETE_URL_TEMPLATE.replace('00000000-0000-0000-0000-000000000000', id);
      try {
        const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }});
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error('Delete failed');
      
        // Hapus dari state  danDOM
        allProductData = allProductData.filter(p => String(p.id) !== String(id));
        grid.querySelector(`[data-product-id="${id}"]`)?.remove();
      
        if (!allProductData.length) showSection({ empty: true });
        showToast('Product deleted successfully', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to delete product', 'error');
      }
      return;
    }
  });
  
  // Sinkronisasi dari modal_product.html tanpa reload
  document.addEventListener('product:added', (e) => {
    const p = e.detail;
    allProductData.unshift(p);
    const el = buildProductCardElement(p);
    grid.classList.remove('hidden');
    grid.insertBefore(el, grid.firstChild);
    emptyState.classList.add('hidden');
  });
  
  document.addEventListener('product:updated', (e) => {
    const p = e.detail;
    const idx = allProductData.findIndex(x => String(x.id) === String(p.id));
    if (idx !== -1) {
      allProductData[idx] = p;
      // refefch agar tampilan konsisten
      fetchProductsFromServer();
    }
  });
  
  document.addEventListener('product:deleted', (e) => {
    const { id } = e.detail;
    const idx = allProductData.findIndex(x => String(x.id) === String(id));
    if (idx !== -1) allProductData.splice(idx, 1);
    grid.querySelector(`[data-product-id="${id}"]`)?.remove();
    if (!allProductData.length) showSection({ empty: true });
  });
  
  
  fetchProductsFromServer();
</script>
{% endblock content %}
